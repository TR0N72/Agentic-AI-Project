input {
  beats {
    port => 5044
  }
  
  tcp {
    port => 5000
    codec => json_lines
  }
  
  udp {
    port => 5000
    codec => json_lines
  }
}

filter {
  if [service] == "nlp-ai-microservice" {
    # Parse structured logs from the NLP AI service
    if [message] {
      if [message] =~ /^\{.*\}$/ {
        json {
          source => "message"
          target => "parsed"
        }
      }
    }
    
    # Extract trace and span IDs for correlation
    if [trace_id] {
      mutate {
        add_field => { "trace_id" => "%{[trace_id]}" }
        add_field => { "span_id" => "%{[span_id]}" }
      }
    }
    
    # Add timestamp if not present
    if ![timestamp] {
      date {
        match => [ "@timestamp", "ISO8601" ]
      }
    }
    
    # Parse error information
    if [exception] {
      if [exception] =~ /^\{.*\}$/ {
        json {
          source => "exception"
          target => "exception_info"
        }
      }
    }
    
    # Add environment and service tags
    mutate {
      add_tag => [ "nlp-ai", "%{[environment]}" ]
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "logstash-%{+YYYY.MM.dd}"
    template_name => "logstash"
    template => "/usr/share/logstash/templates/logstash.json"
    template_overwrite => true
  }
  
  # Debug output (remove in production)
  stdout {
    codec => rubydebug
  }
}

